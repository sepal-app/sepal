{% import "form/fields.html" as form_fields %}

{% macro render_accession_form(form, action, save_button_label="Save", last_accession=None) -%}
    <form method="post" action="{{ action }}">
        {{ form.csrf_token }}
        {{ form.organization_id }}

        <div>
            {{ form.code.label(class_="spl-label") }}
            <div class="mt-1 relative rounded-md shadow-sm">
                {{ form.code(class_="spl-input") }}
                {{ form_fields.render_field_errors(form.code.errors)  }}
            </div>
            {% if last_accession %}
                <p>Last accession was {{ last_accession.code }} ({{ last_accession.taxon.name }}) created on {{ last_accession.created_at }}
            {% endif %}
        </div>

        <div class="mt-4">
            {{ form.taxon_id.label(class_="spl-label") }}
            <div class="mt-1 relative rounded-md shadow-sm">
                {{ form.taxon_id(class_="spl-input spl-ts-select", autocomplete="off") }}
                {{ form_fields.render_field_errors(form.taxon_id.errors)  }}
            </div>
        </div>

        <div class="flex flex-row mt-4 justify-between items-center">
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-700 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >{{ save_button_label }}</button>
        </div>
    </form>

    <script type="module">
     function renderItem(item, escape) {
         // render text property if item is coming from select option else render the
         // item returned from the json response
         // TODO: add query to list request to return as options with text property to
         // simplify rendering and maybe make combobox generic across fields
         return item.text ?
                `<div>${escape(item.text)}</div>` :
                `<div>${escape(item.name)} ${escape(item.author ?? "")}</div>`;
     }

     const taxonField = new TomSelect("#taxon_id", {
         itemClass: "sm:text-sm bg-white",
         maxItems: 1,
         openOnFocus: false,
         optionClass: "sm:text-sm bg-white py-2 px-3",
         plugins: ['clear_button'],
         searchField: ['name'],
         selectOnTab: true,
         valueField: 'id',
         load: (query, callback) => {
             const url = "{{ url_for('taxon.list') }}";
             const params = new URLSearchParams({q: query, page_size: 6});
             taxonField.clear();
             taxonField.clearOptions();
             fetch(url + "?" + params.toString(), {
                 headers: {"Accept": "application/json"}
             })
                 .then(response => response.json())
                 .then(callback)
                 .catch((e)=>{
                     console.error(e)
                     callback();
                 });

         },
         render: {
             option: renderItem,
             item: renderItem,
         }
     });
    </script>
{%- endmacro %}
