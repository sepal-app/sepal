{% import "form/fields.html" as form_fields %}

{% macro render_taxon_form(form, action, save_button_label="Save", taxon=None) -%}
    <form method="post" action="{{ action }}">
        {{ form.csrf_token }}
        {{ form.organization_id }}

        <div>
            {{ form.name.label(class_="spl-label") }}
            <div class="mt-1 relative rounded-md shadow-sm">
                {{ form.name(class_="spl-input") }}
                {{ form_fields.render_field_errors(form.name.errors)  }}
            </div>
        </div>

        <div class="mt-4">
            {{ form.author.label(class_="spl-label") }}
            <div class="mt-1 relative rounded-md shadow-sm">
                {{ form.author(class_="spl-input") }}
                {{ form_fields.render_field_errors(form.author.errors)  }}
            </div>
        </div>

        <div class="mt-4">
            {{ form.rank.label(class_="spl-label") }}
            <div class="mt-1 relative rounded-md shadow-sm">
                {{ form.rank(class_="spl-input spl-ts-select") }}
                {{ form_fields.render_field_errors(form.rank.errors)  }}
            </div>
        </div>

        <div class="mt-4">
            {{ form.parent_id.label(class_="spl-label") }}
            <div class="mt-1 relative rounded-md shadow-sm">
                {{ form.parent_id(class_="spl-input spl-ts-select", autocomplete="off") }}
                {{ form_fields.render_field_errors(form.parent_id.errors)  }}
            </div>
        </div>

        <div class="flex flex-row mt-4 justify-between items-center">
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-700 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            >{{ save_button_label }}</button>
        </div>
    </form>

    <script type="module">
     new TomSelect("#rank", {
         optionClass: "sm:text-sm bg-white py-2 px-3",
         itemClass: "sm:text-sm bg-white",
         selectOnTab: true, allowEmptyOption: true, maxItems: 1, plugins: ['dropdown_input']});


     function renderParent(item, escape) {
         return item.text ?
                `<div>${escape(item.text)}</div>` :
                `<div>${escape(item.name)} ${escape(item.author ?? "")}</div>`
     }

     const taxonId = "{{taxon.id}}"

     const parentField = new TomSelect("#parent_id", {
         itemClass: "sm:text-sm bg-white",
         maxItems: 1,
         openOnFocus: false,
         optionClass: "sm:text-sm bg-white py-2 px-3",
         searchField: 'name',
         selectOnTab: true,
         valueField: 'id',
         load: (query, callback) => {
             const url = "{{ url_for('taxon.list') }}";
             const params = new URLSearchParams({q: query, page_size: 6})
             fetch(url + "?" + params.toString(), {
                 headers: {"Accept": "application/json"}
             })
                 .then(response => response.json())
                 // remove the current taxon from the complete list
                 .then((data) => data.filter((t) => t.id.toString() != taxonId))
                 .then(callback)
                 .catch((e)=>{
                     console.error(e)
                     callback();
                 });

         },
         render: {
             option: renderParent,
             item: renderParent,
         }
     });
    </script>
{%- endmacro %}
